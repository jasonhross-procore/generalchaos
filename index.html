<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="screen-orientation" content="landscape">
    <meta name="orientation" content="landscape">
    <title>General Chaos</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14' fill='%2300ff00'>💥</text></svg>">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Courier New', monospace;
            color: #00ff00;
        }
        
        canvas {
            border: 2px solid #00ff00;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        .game-container {
            text-align: center;
        }
        
        .ui {
            margin-top: 10px;
            font-size: 16px;
        }
        
        .menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 40px;
            border: 2px solid #00ff00;
        }
        
        .hidden {
            display: none !important;
        }
        
        button {
            background: #333;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 10px 20px;
            margin: 10px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            cursor: pointer;
        }
        
        button:hover {
            background: #00ff00;
            color: #333;
        }
        
        .library-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .library-content {
            background: #000;
            border: 3px solid #00ff00;
            width: 90%;
            max-width: 900px;
            height: 80%;
            max-height: 600px;
            display: flex;
            flex-direction: column;
        }
        
        .library-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 2px solid #00ff00;
        }
        
        .library-header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .close-btn {
            background: #ff0000;
            border: 2px solid #ff0000;
            color: #fff;
            padding: 5px 10px;
            margin: 0;
        }
        
        .close-btn:hover {
            background: #fff;
            color: #ff0000;
        }
        
        .library-tabs {
            display: flex;
            background: #111;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px;
            margin: 0;
            border: none;
            border-right: 2px solid #00ff00;
            background: #111;
            font-size: 14px;
        }
        
        .tab-btn:last-child {
            border-right: none;
        }
        
        .tab-btn.active {
            background: #00ff00;
            color: #000;
        }
        
        .tab-btn:hover:not(.active) {
            background: #222;
        }
        
        .library-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .powerup-item, .enemy-item, .chaos-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #333;
            background: #111;
        }
        
        .powerup-sprite, .enemy-sprite {
            width: 40px;
            height: 40px;
            margin-right: 15px;
            border: 1px solid #555;
            position: relative;
        }
        
        .hp-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 15px;
            width: 50px;
        }
        
        .hp-bar-bg {
            width: 40px;
            height: 6px;
            background: #333;
            border: 1px solid #555;
            margin-bottom: 3px;
            position: relative;
        }
        
        .hp-bar-fill {
            height: 100%;
            background: #00ff00;
            transition: width 0.3s ease;
        }
        
        .hp-text {
            font-size: 10px;
            color: #00ff00;
            font-weight: bold;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-size: 16px;
            font-weight: bold;
            color: #00ff00;
            margin-bottom: 5px;
        }
        
        .item-description {
            font-size: 12px;
            color: #ccc;
        }
        
        .weapon-combo {
            margin-bottom: 10px;
            padding: 8px;
            border-left: 3px solid #ff8800;
            background: #1a1a1a;
        }
        
        .combo-name {
            font-weight: bold;
            color: #ff8800;
        }
        
        .combo-components {
            font-size: 12px;
            color: #aaa;
        }
        
        #logoCanvas {
            margin-bottom: 20px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        /* Volume slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #333;
            outline: none;
            border-radius: 5px;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #00ff00;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #333;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #00ff00;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid #333;
        }
        
        /* Mobile Support */
        @media screen and (max-width: 1024px) {
            body {
                min-height: 100vh;
                min-height: 100dvh; /* Dynamic viewport height */
                overflow: auto;
                padding: 10px;
                box-sizing: border-box;
            }
            
            .game-container {
                width: 100%;
                max-width: 100vw;
                box-sizing: border-box;
            }
            
            /* Force landscape orientation */
            @media screen and (orientation: portrait) {
                body::before {
                    content: "Please rotate your device to landscape";
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: #00ff00;
                    padding: 20px;
                    border: 2px solid #00ff00;
                    border-radius: 10px;
                    z-index: 10000;
                    text-align: center;
                    font-size: 18px;
                }
                
                .game-container {
                    filter: blur(5px);
                    pointer-events: none;
                }
            }
            
            /* Mobile full-screen game */
            #gameCanvas {
                max-width: 100vw;
                max-height: 100vh;
                height: 100vh;
                width: 100vw;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 1;
            }
            
            .ui {
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%) scale(0.96);
                z-index: 100;
                background: rgba(0, 0, 0, 0.55);
                padding: 5px 10px;
                border-radius: 3px;
                border: 1px solid rgba(0, 255, 0, 0.75);
                font-size: 11px;
                text-align: center;
                pointer-events: none;
                max-width: 90vw;
            }
            
            .ui-main-stats {
                white-space: nowrap;
                line-height: 1.2;
            }
            
            .ui-main-stats span {
                margin: 0 8px;
                display: inline-block;
            }
            
            #activePowerups {
                display: block;
                margin-top: 3px;
                font-size: 10px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
                line-height: 1.2;
            }
            
            /* Desktop - restore normal layout */
            @media screen and (min-width: 1025px) {
                #gameCanvas {
                    position: relative;
                    width: auto;
                    height: auto;
                    max-width: none;
                    max-height: none;
                }
                
                .ui {
                    position: relative;
                    top: auto;
                    left: auto;
                    transform: none;
                    background: transparent;
                    border: none;
                    font-size: 16px;
                    margin-top: 10px;
                }
                
                .ui-main-stats span {
                    margin: 0 10px;
                }
                
                #activePowerups {
                    font-size: 16px;
                    margin-top: 5px;
                    overflow: visible;
                    white-space: normal;
                }
            }
            
            .menu {
                padding: 15px;
                max-width: 98vw;
                max-height: 85vh;
                overflow-y: auto;
                width: auto;
                min-width: 320px;
            }
            
            button {
                padding: 12px 20px;
                font-size: 14px;
                margin: 6px 4px;
                display: inline-block;
                min-width: 90px;
            }
            
            /* Smaller buttons for main menu on mobile */
            .main-menu-buttons button {
                font-size: 12px;
                padding: 10px 8px;
                margin: 4px 2px;
                min-width: 75px;
            }
            
            /* Stack buttons vertically on very small screens, except main menu buttons */
            @media screen and (max-width: 480px) {
                button:not(.main-menu-buttons button) {
                    display: block;
                    width: calc(100% - 20px);
                    margin: 5px 10px;
                }
                
                .main-menu-buttons {
                    gap: 3px;
                    width: 100%;
                }
                
                .main-menu-buttons button {
                    font-size: 11px;
                    padding: 8px 6px;
                    min-width: 70px;
                    flex: 1 1 auto;
                }
                
                .menu {
                    padding: 10px;
                    max-height: 80vh;
                }
                
                .menu p {
                    font-size: 14px;
                    margin: 8px 0;
                }
            }
        }
        
        /* Main menu button container */
        .main-menu-buttons {
            display: flex;
            flex-wrap: nowrap;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .main-menu-buttons button {
            flex: 0 1 auto;
            min-width: 120px;
            white-space: nowrap;
        }
        
        /* On mobile, make buttons flexible */
        @media screen and (max-width: 1024px) {
            .main-menu-buttons button {
                flex: 1 1 0;
                min-width: 0;
            }
        }
        
        /* Touch controls */
        .mobile-controls {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            z-index: 1000;
            pointer-events: none;
        }
        
        @media screen and (max-width: 1024px) and (orientation: landscape) {
            .mobile-controls.game-active {
                display: flex;
                justify-content: space-between;
                padding: 0 20px;
                pointer-events: auto;
                z-index: 200; /* Above canvas */
            }
            
            body {
                padding: 0;
                margin: 0;
                overflow: hidden;
            }
            
            .menu {
                margin-bottom: 20px;
            }
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        /* Move left and right control groups down to align with pause button */
        .control-group:first-child,
        .control-group:last-child {
            transform: translateY(20px);
        }
        
        /* Keep center group (pause) at original position */
        .center-group {
            transform: translateY(0);
            justify-content: center;
        }
        
        
        .control-btn {
            background: rgba(0, 255, 0, 0.225);
            border: 2px solid rgba(0, 255, 0, 0.75);
            color: rgba(0, 255, 0, 0.9);
            border-radius: 50px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: bold;
            user-select: none;
            touch-action: manipulation;
            min-width: 48px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: scale(0.8);
        }
        
        .control-btn:active {
            background: rgba(0, 255, 0, 0.45);
        }
        
        .move-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .move-controls .control-btn {
            padding: 12px;
            min-width: 48px;
            min-height: 48px;
            font-size: 11px;
        }
        
        /* Center pause button group */
        .center-group {
            justify-content: center;
        }
        
        .pause-btn {
            min-width: 32px !important;
            min-height: 32px !important;
            padding: 6px !important;
            font-size: 14px;
            opacity: 0.6;
        }
        
        /* Settings Modal Styles */
        .settings-section h2 {
            color: #00ff00;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }
        
        .setting-item {
            margin-bottom: 20px;
        }
        
        .setting-item label {
            display: block;
            margin-bottom: 8px;
            color: #00ff00;
            font-size: 14px;
        }
        
        .volume-slider {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .controls-info {
            background: #111;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
        }
        
        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        
        .control-row:last-child {
            border-bottom: none;
        }
        
        .control-key {
            color: #00ff00;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            background: #222;
            padding: 4px 8px;
            border-radius: 3px;
            border: 1px solid #00ff00;
            min-width: 120px;
            text-align: center;
        }
        
        .control-desc {
            color: #ccc;
            font-size: 14px;
        }
        
        /* Tiny Mute Button */
        .tiny-mute {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            margin: 0;
            user-select: none;
            min-width: auto;
            opacity: 0.7;
            width: 40px;
            height: 40px;
            display: inline-block;
            transition: all 0.2s ease;
        }
        
        .tiny-mute:hover {
            opacity: 1;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 4px;
        }
        
        .tiny-mute:active {
            background: rgba(0, 255, 0, 0.2);
            transform: scale(0.95);
        }
        
        .tiny-mute img {
            width: 24px;
            height: 24px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            pointer-events: none; /* Ensures clicks go to button */
        }
        
        /* Make mute button even more tappable on mobile */
        @media screen and (max-width: 1024px) {
            .tiny-mute {
                width: 48px;
                height: 48px;
                padding: 12px;
                pointer-events: auto !important; /* Force button to be clickable */
                position: relative;
                z-index: 10001; /* Above everything else */
            }
            
            .tiny-mute img {
                width: 24px;
                height: 24px;
            }
        }
        
        .mute-container {
            text-align: right;
            margin-top: 15px;
            line-height: 1;
        }
        
        /* Debug Menu Styles */
        .debug-toggles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .debug-toggle {
            display: flex;
            align-items: center;
        }
        
        .toggle-btn {
            background: #333;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 8px 16px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 160px;
            text-align: center;
        }
        
        .toggle-btn:hover {
            background: #555;
        }
        
        .toggle-btn.on {
            background: #00ff00;
            color: #000;
            border-color: #00ff00;
        }
        
        .toggle-btn.off {
            background: #333;
            color: #666;
            border-color: #666;
        }
        
        @media screen and (max-width: 768px) {
            .debug-toggles {
                grid-template-columns: 1fr;
            }
            
            .toggle-btn {
                min-width: 100%;
            }
        }
        
    </style>
</head>
<body>
    <div class="game-container">
        <div id="menu" class="menu">
            <canvas id="logoCanvas" width="400" height="80"></canvas>
            <div class="main-menu-buttons">
                <button onclick="startGame()">START MISSION</button>
                <button onclick="openLibrary()">LIBRARY</button>
                <button onclick="openSettings()">SETTINGS</button>
            </div>
            <div style="margin-top: 20px;">
                <p>WASD/Arrow Keys: Move</p>
                <p>W/↑: Jump | SPACE: Flip Direction</p>
                <p>Survive the increasing chaos!</p>
            </div>
            <div class="mute-container">
                <button class="tiny-mute" id="tinyMuteBtn" title="Toggle music">
                    <img id="muteIcon" src="volumeOn.png" alt="Volume">
                </button>
            </div>
        </div>
        
        <canvas id="gameCanvas" width="800" height="400" class="hidden"></canvas>
        
        <div id="ui" class="ui hidden">
            <div class="ui-main-stats">
                <span>Score: <span id="score">0</span></span>
                <span>Lives: <span id="lives">3</span></span>
                <span>Level: <span id="chaosLevel">1</span></span>
                <span>Shield: <span id="shieldHealth">100</span></span>
                <span>Kills: <span id="killsToNext">10</span></span>
            </div>
            <div id="activePowerups">Active: <span id="powerupList">None</span></div>
        </div>
        
        <div id="gameOver" class="menu hidden">
            <h2>MISSION FAILED</h2>
            <p>Final Score: <span id="finalScore">0</span></p>
            <p>Chaos Level Reached: <span id="finalChaos">1</span></p>
            <button onclick="restartGame()">RETRY MISSION</button>
        </div>
        
        <div id="library" class="library-modal hidden">
            <div class="library-content">
                <div class="library-header">
                    <h1>COMBAT LIBRARY</h1>
                    <button onclick="closeLibrary()" class="close-btn">✕</button>
                </div>
                
                <div class="library-tabs">
                    <button id="powerupsTab" class="tab-btn active" onclick="showTab('powerups')">POWERUPS</button>
                    <button id="enemiesTab" class="tab-btn" onclick="showTab('enemies')">ENEMIES</button>
                    <button id="chaosTab" class="tab-btn" onclick="showTab('chaos')">CHAOS LEVELS</button>
                </div>
                
                <div class="library-body">
                    <div id="powerupsSection" class="tab-content active">
                        <h2>POWERUPS & WEAPON COMBINATIONS</h2>
                        <div id="powerupsList"></div>
                        <h3>WEAPON COMBINATIONS</h3>
                        <div id="weaponCombos"></div>
                    </div>
                    
                    <div id="enemiesSection" class="tab-content">
                        <h2>ENEMY FORCES</h2>
                        <div id="enemiesList"></div>
                    </div>
                    
                    <div id="chaosSection" class="tab-content">
                        <h2>CHAOS LEVEL EFFECTS</h2>
                        <div id="chaosLevels"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="settings" class="library-modal hidden">
            <div class="library-content">
                <div class="library-header">
                    <h1>SETTINGS</h1>
                    <button onclick="closeSettings()" class="close-btn">✕</button>
                </div>
                
                <div class="library-body">
                    <div class="settings-section">
                        <h2>AUDIO SETTINGS</h2>
                        
                        <div class="setting-item">
                            <label for="musicVolume">Music Volume: <span id="musicVolumeValue">70%</span></label>
                            <input type="range" id="musicVolume" min="0" max="100" value="70" class="volume-slider">
                        </div>
                        
                        <div class="setting-item">
                            <label for="sfxVolume">SFX Volume: <span id="sfxVolumeValue">60%</span></label>
                            <input type="range" id="sfxVolume" min="0" max="100" value="60" class="volume-slider">
                        </div>
                        
                        <h2 style="margin-top: 30px;">CONTROLS</h2>
                        
                        <div class="controls-info">
                            <div class="control-row">
                                <span class="control-key">WASD / Arrow Keys</span>
                                <span class="control-desc">Move</span>
                            </div>
                            <div class="control-row">
                                <span class="control-key">W / ↑</span>
                                <span class="control-desc">Jump</span>
                            </div>
                            <div class="control-row">
                                <span class="control-key">SPACE</span>
                                <span class="control-desc">Flip Direction</span>
                            </div>
                            <div class="control-row">
                                <span class="control-key">ESC</span>
                                <span class="control-desc">Pause/Resume</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="debugMenu" class="library-modal hidden">
            <div class="library-content">
                <div class="library-header">
                    <h1>DEBUG MENU</h1>
                    <button onclick="closeDebugMenu()" class="close-btn">✕</button>
                </div>
                
                <div class="library-tabs">
                    <button id="powerupsDebugTab" class="tab-btn active" onclick="showDebugTab('powerups')">POWERUPS</button>
                    <button id="weaponsDebugTab" class="tab-btn" onclick="showDebugTab('weapons')">WEAPONS</button>
                    <button id="specialDebugTab" class="tab-btn" onclick="showDebugTab('special')">SPECIAL</button>
                </div>
                
                <div class="library-body">
                    <div id="powerupsDebugSection" class="tab-content active">
                        <h2>POWERUP TOGGLES</h2>
                        <div class="debug-toggles">
                            <div class="debug-toggle">
                                <button id="toggle-rapidfire" class="toggle-btn off" onclick="togglePowerup('rapidfire')">RAPID FIRE</button>
                            </div>
                            <div class="debug-toggle">
                                <button id="toggle-spin_attack" class="toggle-btn off" onclick="togglePowerup('spin_attack')">SPIN ATTACK</button>
                            </div>
                            <div class="debug-toggle">
                                <button id="toggle-time_warp" class="toggle-btn off" onclick="togglePowerup('time_warp')">TIME WARP</button>
                            </div>
                            <div class="debug-toggle">
                                <button id="toggle-clone" class="toggle-btn off" onclick="togglePowerup('clone')">CLONE SHOT</button>
                            </div>
                            <div class="debug-toggle">
                                <button id="toggle-black_hole" class="toggle-btn off" onclick="togglePowerup('black_hole')">BLACK HOLE</button>
                            </div>
                            <div class="debug-toggle">
                                <button id="toggle-dimension_rift" class="toggle-btn off" onclick="togglePowerup('dimension_rift')">DIMENSION RIFT</button>
                            </div>
                            <div class="debug-toggle">
                                <button id="toggle-matter_converter" class="toggle-btn off" onclick="togglePowerup('matter_converter')">MATTER CONVERTER</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="weaponsDebugSection" class="tab-content">
                        <h2>WEAPON TOGGLES</h2>
                        <div class="debug-toggles">
                            <div class="debug-toggle">
                                <button id="toggle-multishot" class="toggle-btn off" onclick="togglePowerup('multishot')">TRIPLE SHOT</button>
                            </div>
                            <div class="debug-toggle">
                                <button id="toggle-spread_shot" class="toggle-btn off" onclick="togglePowerup('spread_shot')">SPREAD GUN</button>
                            </div>
                            <div class="debug-toggle">
                                <button id="toggle-laser" class="toggle-btn off" onclick="togglePowerup('laser')">LASER BEAM</button>
                            </div>
                            <div class="debug-toggle">
                                <button id="toggle-big_boy" class="toggle-btn off" onclick="togglePowerup('big_boy')">BIG BOY</button>
                            </div>
                            <div class="debug-toggle">
                                <button id="toggle-nuke" class="toggle-btn off" onclick="togglePowerup('nuke')">NUCLEAR BOMB</button>
                            </div>
                            <div class="debug-toggle">
                                <button id="toggle-chaos" class="toggle-btn off" onclick="togglePowerup('chaos')">CHAOS BULLETS</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="specialDebugSection" class="tab-content">
                        <h2>SPECIAL MODES</h2>
                        <div class="debug-toggles">
                            <div class="debug-toggle">
                                <button id="toggle-god_mode" class="toggle-btn off" onclick="togglePowerup('god_mode')">GOD MODE</button>
                            </div>
                            <div class="debug-toggle">
                                <button id="toggle-invincible" class="toggle-btn off" onclick="toggleInvincibility()">INVINCIBILITY</button>
                            </div>
                            <div class="debug-toggle">
                                <button id="toggle-god_gun" class="toggle-btn off" onclick="toggleGodGun()">GOD GUN</button>
                            </div>
                        </div>
                        
                        <h2 style="margin-top: 30px;">GAME CONTROLS</h2>
                        <div class="debug-toggles">
                            <div class="debug-toggle">
                                <button class="toggle-btn" onclick="nextChaosLevel()">NEXT CHAOS LEVEL</button>
                            </div>
                            <div class="debug-toggle">
                                <button class="toggle-btn" onclick="spawnTroopCarrier()">SPAWN TROOP CARRIER</button>
                            </div>
                            <div class="debug-toggle">
                                <button class="toggle-btn" onclick="repairShield()">REPAIR SHIELD</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pause Screen -->
    <div id="pauseScreen" class="library-modal hidden">
        <div class="library-content" style="max-width: 500px; max-height: 400px;">
            <div class="library-header">
                <h1>GAME PAUSED</h1>
                <button onclick="togglePause()" class="close-btn">✕</button>
            </div>
            
            <div class="library-body">
                <div class="settings-section">
                    <h2>VOLUME CONTROLS</h2>
                    
                    <div class="setting-item">
                        <label for="pauseMusicVolume">Music Volume: <span id="pauseMusicVolumeValue">70%</span></label>
                        <input type="range" id="pauseMusicVolume" min="0" max="100" value="70" class="volume-slider">
                    </div>
                    
                    <div class="setting-item">
                        <label for="pauseSfxVolume">SFX Volume: <span id="pauseSfxVolumeValue">60%</span></label>
                        <input type="range" id="pauseSfxVolume" min="0" max="100" value="60" class="volume-slider">
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="togglePause()" style="padding: 15px 30px; font-size: 18px;">RESUME GAME</button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px; font-size: 14px; color: #888;">
                        Press ESC to resume
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mobile Touch Controls -->
    <div class="mobile-controls">
        <div class="control-group">
            <div class="move-controls">
                <div class="control-btn left" data-key="a">←</div>
                <div class="control-btn right" data-key="d">→</div>
            </div>
        </div>
        
        <div class="control-group center-group">
            <div class="control-btn pause-btn" data-key="Escape">⏸</div>
        </div>
        
        <div class="control-group">
            <div class="control-btn" data-key=" ">FLIP</div>
            <div class="control-btn" data-key="w">JUMP</div>
        </div>
    </div>
    
    <script src="game.js"></script>
    
    <script>
        // Volume control handlers
        document.addEventListener('DOMContentLoaded', function() {
            const musicVolumeSlider = document.getElementById('musicVolume');
            const sfxVolumeSlider = document.getElementById('sfxVolume');
            const musicVolumeValue = document.getElementById('musicVolumeValue');
            const sfxVolumeValue = document.getElementById('sfxVolumeValue');
            
            // Pause screen volume controls
            const pauseMusicVolumeSlider = document.getElementById('pauseMusicVolume');
            const pauseSfxVolumeSlider = document.getElementById('pauseSfxVolume');
            const pauseMusicVolumeValue = document.getElementById('pauseMusicVolumeValue');
            const pauseSfxVolumeValue = document.getElementById('pauseSfxVolumeValue');
            
            musicVolumeSlider.addEventListener('input', function() {
                const volume = parseInt(this.value);
                musicVolumeValue.textContent = volume + '%';
                if (window.game && window.game.audio) {
                    window.game.audio.setMusicVolume(volume);
                }
            });
            
            sfxVolumeSlider.addEventListener('input', function() {
                const volume = parseInt(this.value);
                sfxVolumeValue.textContent = volume + '%';
                if (window.game && window.game.audio) {
                    window.game.audio.setSfxVolume(volume);
                }
            });
            
            // Pause screen volume control handlers
            pauseMusicVolumeSlider.addEventListener('input', function() {
                const volume = parseInt(this.value);
                pauseMusicVolumeValue.textContent = volume + '%';
                // Sync with main settings
                musicVolumeSlider.value = volume;
                musicVolumeValue.textContent = volume + '%';
                if (window.game && window.game.audio) {
                    window.game.audio.setMusicVolume(volume);
                }
            });
            
            pauseSfxVolumeSlider.addEventListener('input', function() {
                const volume = parseInt(this.value);
                pauseSfxVolumeValue.textContent = volume + '%';
                // Sync with main settings
                sfxVolumeSlider.value = volume;
                sfxVolumeValue.textContent = volume + '%';
                if (window.game && window.game.audio) {
                    window.game.audio.setSfxVolume(volume);
                }
            });
            
            // Global pause function
            window.togglePause = function() {
                if (window.game && window.game.gameState === 'playing') {
                    window.game.togglePause();
                }
            };
            
            // Function to sync pause screen volume values with current settings
            window.syncPauseScreenVolumes = function() {
                const musicVolume = musicVolumeSlider.value;
                const sfxVolume = sfxVolumeSlider.value;
                
                pauseMusicVolumeSlider.value = musicVolume;
                pauseMusicVolumeValue.textContent = musicVolume + '%';
                pauseSfxVolumeSlider.value = sfxVolume;
                pauseSfxVolumeValue.textContent = sfxVolume + '%';
            };
            
            // Global functions for menu buttons
            window.startGame = function() {
                // Show mobile controls during gameplay
                const mobileControls = document.querySelector('.mobile-controls');
                if (mobileControls) {
                    mobileControls.classList.add('game-active');
                }
                
                // Reset mute icon to ON when game starts (title mute doesn't affect game music)
                const muteIcon = document.getElementById('muteIcon');
                if (muteIcon) {
                    muteIcon.src = 'volumeOn.png';
                }
                
                // Use the game's proper startGame method which stops title music
                if (window.game) {
                    window.game.startGame();
                } else {
                    // If no game exists, create one and start
                    window.game = new Game();
                    window.game.startGame();
                }
            };
            
            window.restartGame = function() {
                document.getElementById('gameOver').classList.add('hidden');
                
                // Reset the game by creating a new instance
                if (window.game) {
                    // Clear any existing intervals or timers if needed
                    window.game = null;
                }
                
                // Create new game instance and start it
                window.game = new Game();
                window.game.startGame();
            };
            
            window.openLibrary = function() {
                console.log('openLibrary called');
                try {
                    if (window.game && window.game.audio) {
                        window.game.audio.playMenuSelect();
                    }
                    document.getElementById('library').classList.remove('hidden');
                    
                    // Try to populate library
                    setTimeout(() => {
                        if (typeof window.populateLibrary === 'function') {
                            window.populateLibrary();
                        } else if (typeof populateLibrary === 'function') {
                            populateLibrary();
                        } else {
                            console.log('populateLibrary function not found');
                        }
                    }, 100);
                } catch (error) {
                    console.error('Error opening library:', error);
                }
            };
            
            window.closeLibrary = function() {
                console.log('closeLibrary called');
                try {
                    if (window.game && window.game.audio) {
                        window.game.audio.playMenuSelect();
                    }
                    document.getElementById('library').classList.add('hidden');
                } catch (error) {
                    console.error('Error closing library:', error);
                }
            };
            
            window.openSettings = function() {
                console.log('openSettings called');
                try {
                    if (window.game && window.game.audio) {
                        window.game.audio.playMenuSelect();
                    }
                    document.getElementById('settings').classList.remove('hidden');
                } catch (error) {
                    console.error('Error opening settings:', error);
                }
            };
            
            window.closeSettings = function() {
                console.log('closeSettings called');
                try {
                    if (window.game && window.game.audio) {
                        window.game.audio.playMenuSelect();
                    }
                    document.getElementById('settings').classList.add('hidden');
                } catch (error) {
                    console.error('Error closing settings:', error);
                }
            };
            
            // Title screen mute functionality
            window.titleMuted = false;
            
            window.toggleTitleMute = function() {
                const muteIcon = document.getElementById('muteIcon');
                if (!muteIcon) return;
                
                // Toggle title mute state
                window.titleMuted = !window.titleMuted;
                
                // Update icon
                muteIcon.src = window.titleMuted ? 'volumeOff.png' : 'volumeOn.png';
                
                // Only control title music, not game music
                if (window.game && window.game.audio && window.game.audio.titleMusic) {
                    window.game.audio.titleMusic.muted = window.titleMuted;
                }
            };
            
            // Simple mute button setup
            const muteBtn = document.getElementById('tinyMuteBtn');
            if (muteBtn) {
                muteBtn.addEventListener('click', window.toggleTitleMute);
                muteBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    window.toggleTitleMute();
                });
            }
            
            // Library tab functions
            window.showTab = function(tabName) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Show selected tab
                document.getElementById(tabName + 'Section').classList.add('active');
                document.getElementById(tabName + 'Tab').classList.add('active');
            };
            
            // Debug menu functions
            window.openDebugMenu = function() {
                if (window.game && window.game.gameState === 'playing') {
                    window.game.togglePause(); // Pause the game
                }
                document.getElementById('debugMenu').classList.remove('hidden');
                updateDebugToggles(); // Update button states
            };
            
            window.closeDebugMenu = function() {
                document.getElementById('debugMenu').classList.add('hidden');
                if (window.game && window.game.paused) {
                    window.game.togglePause(); // Unpause the game
                    
                    // Trigger any pending special powerups
                    if (window.pendingPowerupTriggers && window.pendingPowerupTriggers.length > 0) {
                        const player = window.game.player;
                        
                        window.pendingPowerupTriggers.forEach(powerupType => {
                            switch(powerupType) {
                                case 'black_hole':
                                    if (player.triggerBlackHole) {
                                        player.triggerBlackHole();
                                    }
                                    break;
                                case 'dimension_rift':
                                    if (player.triggerDimensionRift) {
                                        player.triggerDimensionRift();
                                    }
                                    break;
                                case 'matter_converter':
                                    if (player.triggerMatterConverter) {
                                        player.triggerMatterConverter();
                                    }
                                    break;
                                case 'nuke':
                                    // Trigger nuclear explosion
                                    if (window.game.enemies) {
                                        window.game.enemies.forEach(enemy => {
                                            window.game.particles.push(new Particle(enemy.x, enemy.y, 'explosion'));
                                        });
                                        window.game.enemies = []; // Clear all enemies
                                        window.game.score += 1000; // Bonus points
                                        
                                        window.game.floatingTexts.push(new FloatingText(
                                            player.x + player.width / 2,
                                            player.y - 30,
                                            'NUCLEAR DETONATION!',
                                            'nuclear'
                                        ));
                                    }
                                    break;
                            }
                            
                            // Clean up the powerup effect
                            delete player.powerupEffects[powerupType];
                        });
                        
                        // Clear pending triggers
                        window.pendingPowerupTriggers = [];
                    }
                }
            };
            
            window.showDebugTab = function(tabName) {
                // Hide all debug tabs
                document.querySelectorAll('#debugMenu .tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('#debugMenu .tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Show selected debug tab
                document.getElementById(tabName + 'DebugSection').classList.add('active');
                document.getElementById(tabName + 'DebugTab').classList.add('active');
            };
            
            window.togglePowerup = function(powerupType) {
                if (!window.game || !window.game.player) return;
                
                const player = window.game.player;
                const button = document.getElementById('toggle-' + powerupType);
                
                // Special powerups that should trigger immediately
                const immediateTriggerPowerups = ['black_hole', 'dimension_rift', 'matter_converter', 'nuke'];
                
                if (player.powerupEffects[powerupType]) {
                    // Turn off powerup
                    delete player.powerupEffects[powerupType];
                    button.classList.remove('on');
                    button.classList.add('off');
                } else {
                    // Turn on powerup
                    if (immediateTriggerPowerups.includes(powerupType)) {
                        // These powerups trigger immediately when game unpauses
                        player.powerupEffects[powerupType] = 1; // Just mark as active
                        
                        // Store the powerup to trigger when game unpauses
                        if (!window.pendingPowerupTriggers) {
                            window.pendingPowerupTriggers = [];
                        }
                        if (!window.pendingPowerupTriggers.includes(powerupType)) {
                            window.pendingPowerupTriggers.push(powerupType);
                        }
                    } else {
                        // Normal powerups get duration (600 frames = 10 seconds at 60fps)
                        player.powerupEffects[powerupType] = 600;
                    }
                    
                    button.classList.remove('off');
                    button.classList.add('on');
                }
            };
            
            window.toggleInvincibility = function() {
                if (!window.game || !window.game.player) return;
                
                const player = window.game.player;
                const button = document.getElementById('toggle-invincible');
                
                player.debugInvincible = !player.debugInvincible;
                player.invincible = player.debugInvincible;
                
                if (player.debugInvincible) {
                    button.classList.remove('off');
                    button.classList.add('on');
                } else {
                    button.classList.remove('on');
                    button.classList.add('off');
                }
            };
            
            window.toggleGodGun = function() {
                if (!window.game || !window.game.player) return;
                
                const player = window.game.player;
                const button = document.getElementById('toggle-god_gun');
                
                player.godModeGun = !player.godModeGun;
                
                if (player.godModeGun) {
                    button.classList.remove('off');
                    button.classList.add('on');
                } else {
                    button.classList.remove('on');
                    button.classList.add('off');
                }
            };
            
            window.nextChaosLevel = function() {
                if (!window.game) return;
                window.game.chaosLevel++;
                window.game.killCount = 0;
                window.game.killsForNextChaos += Math.floor(window.game.chaosLevel * 5);
                window.game.addChaosEffect();
            };
            
            window.spawnTroopCarrier = function() {
                if (!window.game) return;
                window.game.troopCarriers.push(new TroopCarrier(
                    window.game.canvas.width + 60,
                    324 - 24 // Ground level minus carrier height
                ));
            };
            
            window.repairShield = function() {
                if (!window.game) return;
                window.game.shieldHealth = window.game.maxShieldHealth;
            };
            
            function updateDebugToggles() {
                if (!window.game || !window.game.player) return;
                
                const player = window.game.player;
                
                // Update powerup toggles
                const powerups = ['rapidfire', 'spin_attack', 'time_warp', 'clone', 'black_hole', 
                                'dimension_rift', 'matter_converter', 'multishot', 'spread_shot', 
                                'laser', 'big_boy', 'nuke', 'chaos', 'god_mode'];
                
                powerups.forEach(powerup => {
                    const button = document.getElementById('toggle-' + powerup);
                    if (button) {
                        if (player.powerupEffects[powerup]) {
                            button.classList.remove('off');
                            button.classList.add('on');
                        } else {
                            button.classList.remove('on');
                            button.classList.add('off');
                        }
                    }
                });
                
                // Update special toggles
                const invincibleBtn = document.getElementById('toggle-invincible');
                if (invincibleBtn) {
                    if (player.debugInvincible) {
                        invincibleBtn.classList.remove('off');
                        invincibleBtn.classList.add('on');
                    } else {
                        invincibleBtn.classList.remove('on');
                        invincibleBtn.classList.add('off');
                    }
                }
                
                const godGunBtn = document.getElementById('toggle-god_gun');
                if (godGunBtn) {
                    if (player.godModeGun) {
                        godGunBtn.classList.remove('off');
                        godGunBtn.classList.add('on');
                    } else {
                        godGunBtn.classList.remove('on');
                        godGunBtn.classList.add('off');
                    }
                }
            }
            
            // Mobile touch controls
            const controlBtns = document.querySelectorAll('.control-btn');
            const keys = window.keys || {};
            
            controlBtns.forEach(btn => {
                const key = btn.getAttribute('data-key');
                
                // Touch start - simulate key down
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    btn.style.transform = 'scale(0.95)';
                    
                    if (window.game && window.game.keys) {
                        window.game.keys[key] = true;
                        window.game.keys[key.toLowerCase()] = true;
                        
                        // Special handling for pause button
                        if (key === 'Escape' && window.game.gameState === 'playing') {
                            window.game.togglePause();
                        }
                    }
                }, { passive: false });
                
                // Touch end - simulate key up  
                btn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    btn.style.transform = 'scale(1)';
                    
                    if (window.game && window.game.keys) {
                        window.game.keys[key] = false;
                        window.game.keys[key.toLowerCase()] = false;
                    }
                }, { passive: false });
                
                // Prevent context menu
                btn.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                });
                
                // Handle mouse events for testing on desktop
                btn.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    btn.style.transform = 'scale(0.95)';
                    
                    if (window.game && window.game.keys) {
                        window.game.keys[key] = true;
                        window.game.keys[key.toLowerCase()] = true;
                        
                        // Special handling for pause button
                        if (key === 'Escape' && window.game.gameState === 'playing') {
                            window.game.togglePause();
                        }
                    }
                });
                
                btn.addEventListener('mouseup', (e) => {
                    e.preventDefault();
                    btn.style.transform = 'scale(1)';
                    
                    if (window.game && window.game.keys) {
                        window.game.keys[key] = false;
                        window.game.keys[key.toLowerCase()] = false;
                    }
                });
                
                btn.addEventListener('mouseleave', (e) => {
                    btn.style.transform = 'scale(1)';
                    
                    if (window.game && window.game.keys) {
                        window.game.keys[key] = false;
                        window.game.keys[key.toLowerCase()] = false;
                    }
                });
            });
        });
    </script>
</body>
</html>